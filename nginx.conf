# nginx.conf

# Cache zone for static assets
proxy_cache_path /var/cache/nginx/static
  levels=1:2
  keys_zone=STATIC_CACHE:10m
  max_size=100m
  inactive=7d
  use_temp_path=off;

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=addr:10m;

upstream sveltekit {
  server app:3000;
  keepalive 32;
}

server {
  listen 80;
  server_name _;

  # --- Connection & buffer limits ---
  limit_conn addr 100;
  client_max_body_size 10m;
  client_body_buffer_size 16k;
  client_header_buffer_size 1k;
  large_client_header_buffers 4 8k;

  # --- Timeouts ---
  client_body_timeout 12s;
  client_header_timeout 12s;
  send_timeout 10s;
  proxy_connect_timeout 10s;
  proxy_send_timeout 15s;
  proxy_read_timeout 30s;

  # --- Security headers ---
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-XSS-Protection "0" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

  # Hide nginx version
  server_tokens off;

  # --- Gzip compression ---
  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/json
    application/xml
    image/svg+xml
    font/woff2;

  # --- Immutable static assets (hashed filenames from SvelteKit) ---
  location /_app/immutable/ {
    proxy_pass http://sveltekit;
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    proxy_cache STATIC_CACHE;
    proxy_cache_valid 200 7d;
    proxy_cache_use_stale error timeout updating;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Cache-Status $upstream_cache_status;

    # Re-add security headers (add_header in this block overrides parent)
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
  }

  # --- Other static assets ---
  location ~* \.(?:css|js|jpg|jpeg|png|gif|ico|svg|webp|avif|woff2?|ttf|eot)$ {
    proxy_pass http://sveltekit;
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    proxy_cache STATIC_CACHE;
    proxy_cache_valid 200 1d;
    proxy_cache_use_stale error timeout updating;
    add_header Cache-Control "public, max-age=86400";
    add_header X-Cache-Status $upstream_cache_status;

    add_header X-Content-Type-Options "nosniff" always;
  }

  # --- API routes rate limiting ---
  location /api/ {
    limit_req zone=api burst=20 nodelay;

    proxy_pass http://sveltekit;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # --- Health check (no rate limit, no logging) ---
  location = /health {
    access_log off;
    proxy_pass http://sveltekit;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
  }

  # --- Default: proxy everything else ---
  location / {
    limit_req zone=general burst=60 nodelay;

    proxy_pass http://sveltekit;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }

  # --- Block dotfiles (except .well-known) ---
  location ~ /\.(?!well-known) {
    deny all;
    return 404;
  }
}

# WebSocket upgrade map
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}
